asyncapi: 2.2.0
info:
  title: FFC Pay Batch Processor
  version: '1.0.0'
channels:
  ffc-pay-request:
    publish:
      message:
        $ref: '#/components/messages/PaymentRequest'
  ffc-pay-event:
    publish:
      message:
        $ref: '#/components/messages/Event'

components:
  messages:
    Event:
      contentType: application/json
      payload:
        oneOf:
          - $ref: '#/components/schemas/BatchProcessedEvent'
          - $ref: '#/components/schemas/BatchProcessedErrorEvent'
          - $ref: '#/components/schemas/BatchProcessedPaymentRequestInvalidEvent'
          - $ref: '#/components/schemas/BatchProcessedQuarantineErrorEvent'
    PaymentRequest:
      contentType: application/json
      payload:
        oneOf:
          - $ref: '#/components/schemas/PaymentRequestSitiAgri'
          - $ref: '#/components/schemas/PaymentRequestAHWR'
  schemas:
    BatchProcessedEvent:
      type: object
      description: Info event raised when a payment request is created from a batch file
      required:
        - id
        - message
        - name
        - type_
      properties:
        data:
          type: object
          description: Further information for the event
          properties:
            batchExportDate:
              $ref: '#/components/schemas/BatchExportDate'
            filename:
              $ref: '#/components/schemas/Filename'
            paymentRequest:
              $ref: '#/components/schemas/PaymentRequestSitiAgri'
            sequence:
              $ref: '#/components/schemas/Sequence'
        id:
          $ref: '#/components/schemas/CorrelationId'
        message:
          $ref: '#/components/schemas/Message'
        name:
          $ref: '#/components/schemas/Name'
        type_:
          $ref: '#/components/schemas/Type'
    BatchProcessedErrorEvent:
      type: object
      description: Error event raised when a payment request cannot be created from a batch file
      required:
        - id
        - message
        - name
        - type_
      properties:
        data:
          type: object
          description: Further information for the event
          properties:
            filename:
              $ref: '#/components/schemas/Filename'
        id:
          $ref: '#/components/schemas/CorrelationId'
        message:
          $ref: '#/components/schemas/Message'
        name:
          $ref: '#/components/schemas/Name'
        type_:
          $ref: '#/components/schemas/Type'
    BatchProcessedPaymentRequestInvalidEvent:
      type: object
      description: Error event raised when a payment request cannot be processed
      required:
        - id
        - message
        - name
        - type_
      properties:
        data:
          type: object
          description: Further information for the event
          properties:
            paymentRequest:
              $ref: '#/components/schemas/PaymentRequestSitiAgri'
        id:
          $ref: '#/components/schemas/CorrelationId'
        message:
          $ref: '#/components/schemas/Message'
        name:
          $ref: '#/components/schemas/Name'
        type_:
          $ref: '#/components/schemas/Type'
    BatchProcessedQuarantineErrorEvent:
      type: object
      description: Error event raised when a payment file cannot be processed and is moved into quarantine location
      required:
        - id
        - message
        - name
        - type_
      properties:
        data:
          type: object
          description: Further information for the event
          properties:
            filename:
              $ref: '#/components/schemas/Filename'
        id:
          $ref: '#/components/schemas/CorrelationId'
        message:
          $ref: '#/components/schemas/Message'
        name:
          $ref: '#/components/schemas/Name'
        type_:
          $ref: '#/components/schemas/Type'
    PaymentRequestAHWR:
      type: object
      description: Vet Visit payment object
      required:
        - agreementNumber
        - frn
        - invoiceLines
        - invoiceNumber
        - marketingYear
        - paymentRequestNumber
        - sbi
        - sourceSystem
        - value
      properties:
        agreementNumber:
          $ref: '#/components/schemas/AgreementNumber'
        contractNumber:
          $ref: '#/components/schemas/ContractNumber'
        correlationId:
          $ref: '#/components/schemas/CorrelationId'
        currency:
          $ref: '#/components/schemas/Currency'
        dueDate:
          $ref: '#/components/schemas/DueDate'
        frn:
          $ref: '#/components/schemas/FRN'
        invoiceLines:
          type: array
          description: List of Invoice lines that make up request
          items:
            type: object
            required:
              - accountCode
              - description
              - schemeCode
              - value
            properties:
              schemeCode:
                $ref: '#/components/schemas/SchemeCode'
              accountCode:
                $ref: '#/components/schemas/AccountCode'
              description:
                $ref: '#/components/schemas/Description'
              value:
                $ref: '#/components/schemas/ValueDecimal'
        invoiceNumber:
          $ref: '#/components/schemas/InvoiceNumber'
        marketingYear:
              $ref: '#/components/schemas/MarketingYear'
        paymentRequestNumber:
          $ref: '#/components/schemas/PaymentRequestNumber'
        schedule:
          $ref: '#/components/schemas/Schedule'
        sourceSystem:
          $ref: '#/components/schemas/SourceSystem'
        value:
          $ref: '#/components/schemas/ValueDecimal'
    PaymentRequestSitiAgri:
      type: object
      description: SITI Agri payment object
      required:
        - agreementNumber
        - frn
        - invoiceLines
        - invoiceNumber
        - marketingYear
        - paymentRequestNumber
        - sbi
        - sourceSystem
        - value
      properties:
        agreementNumber:
          $ref: '#/components/schemas/AgreementNumber'
        contractNumber:
          $ref: '#/components/schemas/ContractNumber'
        correlationId:
          $ref: '#/components/schemas/CorrelationId'
        currency:
          $ref: '#/components/schemas/Currency'
        dueDate:
          $ref: '#/components/schemas/DueDate'
        frn:
          $ref: '#/components/schemas/FRN'
        invoiceLines:
          type: array
          description: List of Invoice lines that make up request
          items:
            type: object
            required:
              - accountCode
              - description
              - schemeCode
              - value
            properties:
              schemeCode:
                $ref: '#/components/schemas/SchemeCode'
              accountCode:
                $ref: '#/components/schemas/AccountCode'
              description:
                $ref: '#/components/schemas/Description'
              value:
                $ref: '#/components/schemas/ValueDecimal'
        invoiceNumber:
          $ref: '#/components/schemas/InvoiceNumber'
        marketingYear:
              $ref: '#/components/schemas/MarketingYear'
        paymentRequestNumber:
          $ref: '#/components/schemas/PaymentRequestNumber'
        schedule:
          $ref: '#/components/schemas/Schedule'
        sourceSystem:
          $ref: '#/components/schemas/SourceSystem'
        value:
          $ref: '#/components/schemas/ValueDecimal'
    AccountCode:
      type: string
      description: Unique account code for budgeting
      example: SOS273
    AgreementNumber:
      type: string
      description: Unique reference number for agreement/application
      example: SIP001000000001
    BatchExportDate:
      type: string
      format: DD-MM-YYYY
      description: Date SITI Agri exported payment file
      example: "2022-12-01"
    ContractNumber:
      type: string
      description: Contract reference number of agreement
      example: S0000001
    CorrelationId:
      type: string
      format: uuid
      description: GUID for event correlation, optional
      example: ce6ec916-bebe-4bc0-bad1-255298c82845
    Currency:
      type: string
      description: Currency of values in request. If not supplied will default to GBP.
      enum:
        - GBP
        - EUR
      example: GBP
      default: GBP
    Description:
      type: string
      pattern: ^\w$
      minLength: 3
      maxLength: 99
      description: Description of what line relates to, eg gross or penalty
      example: G00 - Gross value of claim
    Filename:
      type: string
      description: Name of the payment file
      example: "80001"
    FRN:
      type: number
      description: Firm Reference Number
      minimum: 1000000000
      maximum: 9999999999
      example: "1000000001"
    DueDate:
      type: string
      format: DD/MM/YYYY, YYYY/MM/DD, DD-MM-YYYY or YYYY-MM-DD
      description: Date request should be issued from.  If not supplied will default to current date.
      example: "2022-12-01"
      default: Current date
    InvoiceNumber:
      type: string
      description: Unique identifier for payment request
      example: SFIP0000001
    MarketingYear:
      type: number
      description: Scheme year for request
      minimum: 2021
      maximum: 2099
      example: 2022
    Message:
      type: string
      description: Event message
      enum:
        - others from error.message
        - Payment request could not be processed. Error(s) $paymentRequest.errorMessage
        - Payment request created from batch file
        - Quarantined $filename
      example: Payment request created from batch file
    Name:
      type: string
      description: Name of the event
      enum:
        - batch-processing
        - batch-processing-error
        - batch-processing-payment-request-invalid
        - batch-processing-quarantine-error
      example: batch-processing
    PaymentRequestNumber:
      type: number
      description: Version of payment request starting with 1, anything greater than 1 is an adjustment
      minimum: 1
      maximum: 99
      example: 1
    SBI:
      type: number
      description: Single Business Identifier
      minimum: 105000000
      maximum: 999999999
      example: 123456789
    Schedule:
      type: string
      description: Payment frequency instruction for DAX, eg Q4 for quarterly payments, optional.
      enum:
        - Q4
        - M12
        - T4
      example: Q4
    SchemeCode:
      type: string
      description: Unique funding option code
      example: "80001"
    Sequence:
      type: string
      description: Sequence number
      example: "0001"
    SourceSystem:
      type: string
      description: System identifier request originates from
      example: SFIP
    Type:
      type: string
      description: Type of the event
      enum:
        - error
        - info
      example: info
    ValueDecimal:
      type: number
      format: decimal
      description: Decimal net value of request before enrichment, ie decimal value in specified currency
      minimum: 0.00
      maximum: 999999999999.99
      example: 500.99
